<link rel="stylesheet" href="http://0.0.0.0:5000/static/vendor/bootstrap/2.0.4/bootstrap.min.css" />
<link rel="stylesheet" href="http://0.0.0.0:5000/static/vendor/bootstrap/2.0.4/bootstrap-responsive.min.css" />

<div class="row">
  <!-- Success and Error Messages for the user -->
  <!-- Question, task id, photo and action buttons for answering the question-->
  <div class="span8 offset2" style="height:50px">
    <div id="success" class="alert alert-success" style="display:none;">
      <a class="close">×</a>
      <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="finish" class="alert alert-success" style="display:none;">
      <strong>Congratulations!</strong> All the tasks have been completed!</strong>
      <br/>
      <div class="alert-actions">
              <a class="btn small" href="/">Go back</a>
              <a class="btn small" href="/app">or, Check other applications</a>
      </div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
      <a class="close">×</a>
      <strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
  </div> <!-- End Success and Error Messages for the user -->
</div>

<div id="throbber"></div>

<h2>Transcribe the coordinates in the image on the left in the right hand box</h2>

<div class="row skeleton" style="padding-top:10px;">
  <div class="span6">
      <img id="photo" src="http://img339.imageshack.us/img339/9017/loadingo.png" onload="spinnerStop()" style="max-width=100%">
  </div>
  <div class="span6">
    <textarea placeholder="Transcribe it here!" class="span5" style="height: 400px;"></textarea>
  </div>
</div>

<script src="http://0.0.0.0:5000/static/vendor/jquery.js"></script>
<script src="http://0.0.0.0:5000/static/js/pybossa/pybossa.js"></script>
<script src="/static/js/throbber/throbber.js" type="text/javascript"></script>
<script>
var spinner = new Throbber({
    color: 'black',
    size: 90
});

// The spinner is attached to a div overlayed in top of the photo.
// This div is only shown when the spinner is active,
// otherwise, the div is hidden from the view to show the photo.¬

spinner.appendTo (document.getElementById('throbber'));

// This function shows the spinner div and starts its animation¬
function spinnerStart() {
    $("#throbber").show();
    spinner.start();
    console.log("Spinner started!");
}

// This function stops the spinner and hides the spinner div¬
function spinnerStop() {
    spinner.stop()
    $("#throbber").hide();
    console.log("Spinner stopped!");
}
// Function to load the TaskRun data into the HTML skeleton
function loadData( data ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    if ( !$.isEmptyObject(data.task) ) {
        spinnerStart();
        $("#question h2").text(data.question);
        $("#task-id").text(data.task.id);
        $("#photo-link").attr("href", data.task.info.link);
        $("#photo").attr("src",data.task.info.url_m);
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
}

function loadTask( task_id ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    var t = $.ajax({
        url: '/api/task/'+task_id,
        dataType: 'json'
    });
    t.done( function (task) {
        if ( !$.isEmptyObject(task) ) {
            spinnerStart();
            if (task.state=='completed') {
                $('#answer').hide();
                $('#taskcompleted').show();
            }
            loadUserProgress();
            $("#question h2").text(task.info.question);
            $("#task-id").text(task.id);
            $("#photo").attr("src", task.info.image_url);
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}

function loadUserProgress() {
    pybossa.userProgress('awesome').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        //$("#progress").tooltip({'placement': 'left'});
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

// Function to submit and save the TaskRun in PyBossa
function submitTask(answer) {
    // Get the task-id
    var taskid = $("#task-id").text();
    // Save the task
    pybossa.saveTask(taskid, answer).done( function( data ) {
        // Uncoment next line for debugging purposes
        //console.log("Answer saved!");
        // FadeIn & Out the success div feedback
        $("#success").fadeIn();
        setTimeout(function() { $("#success").fadeOut() }, 2000);
        // Load a new task
        //pybossa.newTask("awesome").done( function( data ){ loadData( data ) });
        window.location.pathname = "/app/awesome/newtask";
    });
}

// Check if the user is loading directly a task or requesting a new one
var taskId = pybossa.getCurrentTaskId(window.location.pathname);

if (taskId){
    // The user is loading directly a task, so load then input data
    loadTask(taskId);
}
else {
    // The user is requesting a new task, so get a new one
    pybossa.newTask("awesome").done( function( data ) {
    console.log('new task!');

        if ( !$.isEmptyObject(data.task) ) {
            window.location.pathname = "/app/awesome/task/" + data.task.id;
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}
</script>
<!--
<script>
var img = 'http://www.europeana1914-1918.eu/attachments/34532/2696.34532.large.jpg';
      $(document).ready(function(){
          $(".viewer").iviewer(
             {
               src: img,
               update_on_resize: false,
               initCallback: function ()
               {
                   var object = this;
                   $("#in").click(function(){ object.zoom_by(1);});
                   $("#out").click(function(){ object.zoom_by(-1);});
                   $("#fit").click(function(){ object.fit();});
                   $("#orig").click(function(){  object.set_zoom(100); });
                   $("#update").click(function(){ object.update_container_info();});
               },
               onMouseMove: function(object, coords) { },
               onStartDrag: function(object, coords) { return true; }, //this image will not be dragged
               onDrag: function(object, coords) { }
          });
      });
</script>
-->
